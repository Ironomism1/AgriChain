# Complete System Architecture - Razorpay Escrow + Blockchain

## High-Level Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AGRICHAIN ECOSYSTEM                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    USER / FARMER         â”‚
                    â”‚  (Dashboard)             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  STAGE 1: CREATE ESCROW  â”‚
                    â”‚  POST /api/escrow/init   â”‚
                    â”‚  Status: pending         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     MONGODB DATABASE              â”‚
                    â”‚  EscrowTransaction Record         â”‚
                    â”‚  â”œâ”€ Status: pending               â”‚
                    â”‚  â”œâ”€ Amount: 50000                 â”‚
                    â”‚  â””â”€ Blockchain: null              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  STAGE 2: RAZORPAY PAYMENT   â”‚
                    â”‚  Payment Page                â”‚
                    â”‚  â”œâ”€ create-order            â”‚
                    â”‚  â”œâ”€ User pays               â”‚
                    â”‚  â””â”€ verify-payment          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                      â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RAZORPAY  â”‚    â”‚     MONGODB        â”‚    â”‚   USER NOTIF â”‚
    â”‚            â”‚    â”‚                    â”‚    â”‚   (SMS/Email)â”‚
    â”‚ â”œâ”€ Order   â”‚    â”‚ Status: funded     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ â”œâ”€ Payment â”‚    â”‚ RzpOrderId: xxx    â”‚
    â”‚ â””â”€ Transferâ”‚    â”‚ RzpPaymentId: yyy  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  STAGE 3: SMART CONTRACT       â”‚
         â”‚  â”œâ”€ Prepare contract           â”‚
         â”‚  â”œâ”€ MetaMask popup             â”‚
         â”‚  â”œâ”€ User confirms              â”‚
         â”‚  â””â”€ contract.ReportCrime()     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ETHEREUMâ”‚    â”‚ MONGODB   â”‚    â”‚  FRONTEND   â”‚
    â”‚POLYGON â”‚    â”‚           â”‚    â”‚   UPDATE    â”‚
    â”‚   BSC  â”‚    â”‚Status:    â”‚    â”‚  Status     â”‚
    â”‚        â”‚    â”‚confirmed  â”‚    â”‚             â”‚
    â”‚txHash: â”‚    â”‚TxHash:    â”‚    â”‚  confirmed  â”‚
    â”‚0x123..â”‚    â”‚0x123...   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Detailed Transaction States

### DATABASE TIMELINE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIME 0: User fills contract form on Dashboard                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EscrowTransaction Created:                                          â”‚
â”‚ {                                                                    â”‚
â”‚   _id: ObjectId,                                                    â”‚
â”‚   transactionId: "ESC-1700000000000-abc123",                       â”‚
â”‚   buyerId: ObjectId(user),                                         â”‚
â”‚   sellerId: ObjectId(farmer),                                      â”‚
â”‚   amount: 50000,                                                    â”‚
â”‚   status: "pending",                     â—„â”€â”€â”€ STAGE 1 COMPLETE    â”‚
â”‚   funds: { inEscrow: 0, released: 0 },                            â”‚
â”‚   payment: { status: "pending" },                                  â”‚
â”‚   blockchain: { txHash: null }                                     â”‚
â”‚ }                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIME 1: Payment completed on Razorpay                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EscrowTransaction Updated:                                          â”‚
â”‚ {                                                                    â”‚
â”‚   status: "funded",                      â—„â”€â”€â”€ STAGE 2 COMPLETE    â”‚
â”‚   funds: { inEscrow: 50000, released: 0 },                        â”‚
â”‚   payment: {                                                        â”‚
â”‚     status: "confirmed",                                            â”‚
â”‚     method: "card",                                                 â”‚
â”‚     razorpayOrderId: "order_EbVgdvZT9A0Jxi",                     â”‚
â”‚     razorpayPaymentId: "pay_EbVi1K1wLmAQqU",                     â”‚
â”‚     confirmedAt: ISODate("2024-11-20T10:30:00Z")                 â”‚
â”‚   },                                                                â”‚
â”‚   blockchain: { txHash: null } â—„â”€â”€â”€ Waiting for contract deploy  â”‚
â”‚ }                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIME 2: Smart contract deployed on blockchain via MetaMask          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EscrowTransaction Updated:                                          â”‚
â”‚ {                                                                    â”‚
â”‚   status: "confirmed",                   â—„â”€â”€â”€ STAGE 3 COMPLETE    â”‚
â”‚   blockchain: {                                                     â”‚
â”‚     txHash: "0x7f3e2b1a4c5d6e9f8a0b1c2d3e4f5a6b7c8d9e0f",       â”‚
â”‚     smartContractAddress: "0x1234567890abcdef...",               â”‚
â”‚     network: "ethereum",                                            â”‚
â”‚     status: "recorded",                                             â”‚
â”‚     recordedAt: ISODate("2024-11-20T10:35:00Z")                 â”‚
â”‚   }                                                                  â”‚
â”‚ }                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIME 3: Product delivered, buyer confirms                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EscrowTransaction Updated:                                          â”‚
â”‚ {                                                                    â”‚
â”‚   status: "confirmed",                   â—„â”€â”€â”€ STAGE 4 COMPLETE    â”‚
â”‚   delivery: {                                                       â”‚
â”‚     status: "delivered",                                            â”‚
â”‚     actualDelivery: ISODate("2024-11-21T14:00:00Z")              â”‚
â”‚   },                                                                â”‚
â”‚   buyerConfirmation: {                                              â”‚
â”‚     status: "confirmed",                                            â”‚
â”‚     confirmedAt: ISODate("2024-11-21T14:30:00Z"),                â”‚
â”‚     photosUploaded: ["url1", "url2"]                              â”‚
â”‚   },                                                                â”‚
â”‚   releaseAuthorization: {                                           â”‚
â”‚     buyerAuthorized: true,                                          â”‚
â”‚     autoReleaseScheduledFor: ISODate("2024-11-26T14:30:00Z")   â”‚ â—„â”€â”€â”
â”‚   },                                                                â”‚  â”‚
â”‚   autoReleaseScheduledFor: ISODate("2024-11-26T14:30:00Z")   â—„â”€â”€â”˜  â”‚
â”‚ }                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIME 4: Auto-release timer expires OR manual release               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EscrowTransaction FINAL:                                            â”‚
â”‚ {                                                                    â”‚
â”‚   status: "released",                    â—„â”€â”€â”€ STAGE 5 COMPLETE    â”‚
â”‚   funds: {                                                          â”‚
â”‚     inEscrow: 0,                                                    â”‚
â”‚     released: 49000  â—„â”€â”€â”€ (50000 - 1000 platform fee 2%)         â”‚
â”‚   },                                                                â”‚
â”‚   releaseAuthorization: {                                           â”‚
â”‚     releasedAt: ISODate("2024-11-26T14:30:00Z"),                 â”‚
â”‚     releasedBy: "system"  â—„â”€â”€â”€ Auto-release                       â”‚
â”‚   },                                                                â”‚
â”‚   completedAt: ISODate("2024-11-26T14:30:00Z")                  â”‚
â”‚ }                                                                    â”‚
â”‚                                                                      â”‚
â”‚ Razorpay Payout to Seller: â‚¹49,000                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API Call Sequence

```
TIMELINE â†’ API CALLS:

T=0s   â”‚
       â”œâ”€ POST /api/escrow/initiate
       â”‚  â””â”€ Create escrow (status: pending)
       â”‚
       â””â”€> Redirect to /payment?escrowId=xxx&amount=xxx

T=5s   â”‚
       â”œâ”€ POST /api/payments/create-order
       â”‚  â””â”€ Razorpay creates order
       â”‚
       â”œâ”€ Razorpay Modal Opens
       â”‚  â””â”€ User enters payment details
       â”‚
       â””â”€> User confirms payment

T=10s  â”‚
       â”œâ”€ Razorpay charges user's card
       â”‚
       â””â”€> Razorpay returns payment ID + signature

T=12s  â”‚
       â”œâ”€ POST /api/payments/verify-payment
       â”‚  â”œâ”€ Verify signature
       â”‚  â”œâ”€ Check payment.captured = true
       â”‚  â””â”€ Update escrow (status: funded)
       â”‚
       â””â”€> Payment Page shows "Deploy Smart Contract"

T=15s  â”‚
       â”œâ”€ User clicks "Deploy Smart Contract"
       â”‚
       â”œâ”€ POST /api/contracts/create-onchain
       â”‚  â””â”€ Verify payment is confirmed
       â”‚
       â””â”€> MetaMask popup opens

T=20s  â”‚
       â”œâ”€ User confirms MetaMask transaction
       â”‚
       â”œâ”€ contract.ReportCrime() executes
       â”‚  â””â”€ On blockchain (Ethereum/Polygon/BSC)
       â”‚
       â””â”€> Transaction hash generated

T=25s  â”‚
       â”œâ”€ POST /api/contracts/store-blockchain-hash
       â”‚  â”œâ”€ Store txHash
       â”‚  â”œâ”€ Store contractAddress
       â”‚  â””â”€ Update escrow (status: confirmed)
       â”‚
       â””â”€> Redirect to /escrow-tracking

T=3600s (1 hour later) â”‚
       â”œâ”€ Buyer views product
       â”‚
       â”œâ”€ POST /api/escrow/:id/confirm-delivery
       â”‚  â””â”€ Update delivery, schedule auto-release
       â”‚
       â””â”€> Auto-release in 5 days

T=432000s (5 days later) â”‚
       â”œâ”€ Scheduled release triggers
       â”‚
       â”œâ”€ POST /api/escrow/:id/release-funds
       â”‚  â”œâ”€ Calculate seller amount (50000 - 1000 fee = 49000)
       â”‚  â”œâ”€ Update escrow (status: released)
       â”‚  â””â”€ Trigger Razorpay payout
       â”‚
       â”œâ”€ Razorpay transfers â‚¹49,000 to seller account
       â”‚
       â””â”€> Transaction complete âœ“
```

---

## State Machine Diagram

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PENDING    â”‚
                    â”‚  (Escrow OK, â”‚
                    â”‚   No payment)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              POST /api/escrow/initiate
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     FUNDED     â”‚
                    â”‚ (Razorpay OK,  â”‚
                    â”‚   $ in escrow) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
         POST /api/contracts/create-onchain
         POST /api/contracts/store-blockchain-hash
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CONFIRMED      â”‚
                    â”‚ (Blockchain OK,  â”‚
                    â”‚   Delivery OK)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              POST /api/escrow/release-funds
              (auto or manual)
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    RELEASED    â”‚
                    â”‚ ($ to seller,  â”‚
                    â”‚   Complete)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ERROR PATHS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DISPUTE  â”‚ â—„â”€â”€ POST /api/escrow/raise-dispute
â”‚(Paused)  â”‚     (at any stage after funded)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ REFUNDED â”‚ â—„â”€â”€ Admin resolves dispute
â”‚(To buyer)â”‚     Revert transaction
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## System Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FRONTEND (React)                              â”‚
â”‚  â”œâ”€ Dashboard.js ........... Form submission (STAGE 1)         â”‚
â”‚  â”œâ”€ payment-page.js ........ Razorpay + MetaMask (S2, S3)     â”‚
â”‚  â””â”€ escrow-tracking.js ..... Delivery + Release (S4, S5)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ HTTP Requests
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BACKEND (Node.js + Express)                       â”‚
â”‚  â”œâ”€ escrow.js .............. Escrow endpoints (S1, S4, S5)   â”‚
â”‚  â”œâ”€ razorpay-payment.js .... Razorpay API wrapper (S2)       â”‚
â”‚  â””â”€ contracts.js ........... Blockchain integration (S3)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            â”‚                â”‚              â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Mongo â”‚    â”‚Razorpay â”‚    â”‚ Blockchain â”‚    â”‚ Ethereum / â”‚
â”‚ DB   â”‚    â”‚  API    â”‚    â”‚   RPC Node â”‚    â”‚  Polygon   â”‚
â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Success Indicators

```
âœ“ Stage 1: Escrow created, redirect to payment page
âœ“ Stage 2: Razorpay payment successful, funds in escrow
âœ“ Stage 3: Smart contract on blockchain, hash stored
âœ“ Stage 4: Delivery confirmed, auto-release scheduled
âœ“ Stage 5: Funds released to seller, transaction complete
```

---

This is the complete integration! ğŸ‰
